<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .brand-logo {
        height: 48px;
        width: auto;
      }
      @media (max-width: 576px) {
        .brand-logo {
          height: 40px;
        }
      }
    </style>
    <title>{% block title %}{% endblock %} - StockCraft</title>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm sticky-top"
    >
      <div class="container-fluid">
        <a
          class="navbar-brand d-flex align-items-center fw-bold gap-2"
          href="{{ url_for('home') }}"
        >
          <img
            src="{{ url_for('static', filename='images/stockcraft_logo.png') }}"
            alt="StockCraft logo"
            class="brand-logo"
          />
          <span>StockCraft</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('home') }}">Home</a>
            </li>

            {% if current_user.is_authenticated %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('wallet') }}">Wallet</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('stocks') }}">Stocks</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('portfolio_index') }}"
                >Portfolio</a
              >
            </li>

            {% if current_user.is_admin %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('admin_dashboard') }}"
                >Admin</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('users') }}">Users</a>
            </li>
            {% endif %} {% endif %}
          </ul>

          <ul class="navbar-nav ms-auto">
            {% if current_user.is_authenticated %}
            <li class="nav-item me-4">
              <span class="navbar-text text-warning fw-semibold">
                Wallet: {% if wallet_balance is not none %} ${{
                '%.2f'|format(wallet_balance) }} {% else %} $0.00 {% endif %}
              </span>
            </li>

            <li class="nav-item">
              <span class="navbar-text me-3"
                >Hi, {{ current_user.username }}{% if current_user.is_admin %}
                (Admin){% endif %}</span
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </li>
            {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('login') }}">Login</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('signup') }}">Sign Up</a>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">{% block content %}{% endblock %}</div>

    <footer class="bg-dark text-light mt-5">
      <div class="container py-3">
        <p class="text-center mb-0">Â© 2025 Wealth Fargo Group</p>
      </div>
    </footer>

    <div
      class="modal fade"
      id="tradeConfirmModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="tradeModalTitle">Confirm Trade</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-between">
              <div>Action</div>
              <div id="mcAction" class="fw-semibold"></div>
            </div>
            <div class="d-flex justify-content-between">
              <div>Ticker</div>
              <div id="mcTicker" class="fw-semibold"></div>
            </div>
            <div class="d-flex justify-content-between">
              <div>Quantity</div>
              <div id="mcQty" class="fw-semibold"></div>
            </div>
            <div class="d-flex justify-content-between">
              <div>Price</div>
              <div id="mcPrice" class="fw-semibold"></div>
            </div>
            <hr class="opacity-25" />
            <div class="d-flex justify-content-between fs-5">
              <div>Total</div>
              <div id="mcTotal" class="fw-bold"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" id="mcConfirmBtn" class="btn btn-primary">
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      (function () {
        const isAuthed = {{ 'true' if current_user.is_authenticated else 'false' }};
        const STORAGE_KEY = "stockcraft_pnl_series";

        function loadPnlSeries() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return { labels: [], data: [] };
            const parsed = JSON.parse(raw);
            return {
              labels: Array.isArray(parsed.labels) ? parsed.labels : [],
              data: Array.isArray(parsed.data) ? parsed.data : [],
            };
          } catch (e) {
            return { labels: [], data: [] };
          }
        }

        function savePnlSeries(series) {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(series));
          } catch (e) {}
        }

        let pnlSeries = loadPnlSeries();
        let pnlChart = null;

        const pnlCanvas = document.getElementById("pnlChart");
        if (pnlCanvas && window.Chart) {
          const ctx = pnlCanvas.getContext("2d");
          pnlChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: [...pnlSeries.labels],
              datasets: [
                {
                  label: "Unrealized P/L",
                  data: [...pnlSeries.data],
                  tension: 0.25,
                  fill: false,
                  borderWidth: 2,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
                y: { ticks: { callback: (v) => "$" + Number(v).toFixed(2) } },
              },
            },
          });
        }

        window.stockcraft_push_pnl = function (pnl) {
          if (!isFinite(pnl)) return;

          const now = new Date();
          const label = now.toLocaleTimeString([], {
            hour12: false,
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });

          pnlSeries.labels.push(label);
          pnlSeries.data.push(pnl);

          const maxPoints = 100;
          if (pnlSeries.labels.length > maxPoints) {
            pnlSeries.labels = pnlSeries.labels.slice(-maxPoints);
            pnlSeries.data = pnlSeries.data.slice(-maxPoints);
          }

          savePnlSeries(pnlSeries);

          if (pnlChart) {
            pnlChart.data.labels = [...pnlSeries.labels];
            pnlChart.data.datasets[0].data = [...pnlSeries.data];
            pnlChart.update();
          }
        };

        if (isAuthed) {
          async function pollPnl() {
            try {
              const resp = await fetch("/api/portfolio_updater", { cache: "no-store" });
              if (!resp.ok) return;
              const json = await resp.json();
              if (typeof json.total_pnl === "number") {
                window.stockcraft_push_pnl(json.total_pnl);
              }
            } catch (e) {}
          }

          pollPnl();
          setInterval(pollPnl, 10000);
        }

        let pendingForm = null;
        const modalEl = document.getElementById("tradeConfirmModal");
        const modal = modalEl ? new bootstrap.Modal(modalEl) : null;
        const elAction = document.getElementById("mcAction");
        const elTicker = document.getElementById("mcTicker");
        const elQty = document.getElementById("mcQty");
        const elPrice = document.getElementById("mcPrice");
        const elTotal = document.getElementById("mcTotal");
        const btnConfirm = document.getElementById("mcConfirmBtn");
        const modalTitle = document.getElementById("tradeModalTitle");

        document.addEventListener("submit", function (e) {
          const form = e.target;
          const confirmType = form.getAttribute("data-confirm");
          if (!confirmType || !modal) return;

          e.preventDefault();

          const action = (form.getAttribute("data-action") || "trade").toUpperCase();

          let tkr = (form.getAttribute("data-ticker") || "").toUpperCase();
          if (!tkr) {
            const sel = form.querySelector("select[name='stock_id']");
            const opt = sel ? sel.options[sel.selectedIndex] : null;
            if (opt && opt.dataset.ticker) {
              tkr = String(opt.dataset.ticker).toUpperCase();
            }
          }
          if (!tkr) {
            const row = form.closest("[data-role='position-row']");
            if (row) {
              tkr = String(row.getAttribute("data-ticker") || "").toUpperCase();
            }
          }

          const qty = Number(form.querySelector("input[name='quantity']")?.value || 0);

          let price = 0;
          const priceInput = form.querySelector("input[name='price']");
          if (priceInput && priceInput.value) {
            price = Number(priceInput.value);
          }
          if (!price) {
            const formPriceEl = form.querySelector("[data-field='price'], [data-field='last-price']");
            if (formPriceEl) {
              price = Number(String(formPriceEl.textContent || "0").replace(/[^0-9.\-]/g, ""));
            }
          }

          if (!isFinite(price)) price = 0;

          const total = qty * price;

          if (modalTitle) modalTitle.textContent = `Confirm ${action}`;
          if (elAction) elAction.textContent = action;
          if (elTicker) elTicker.textContent = tkr || "-";
          if (elQty) elQty.textContent = qty.toString();
          if (elPrice) elPrice.textContent = `$${price.toFixed(2)}`;
          if (elTotal) elTotal.textContent = `$${total.toFixed(2)}`;

          if (priceInput) priceInput.value = price.toFixed(2);

          pendingForm = form;
          modal.show();
        });

        if (btnConfirm) {
          btnConfirm.addEventListener("click", function () {
            if (pendingForm) {
              modal.hide();
              const f = pendingForm;
              pendingForm = null;
              f.submit();
            }
          });
        }
      })();
    </script>
  </body>
</html>
