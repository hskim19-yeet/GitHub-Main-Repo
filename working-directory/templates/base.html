<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <title>{% block title %}{% endblock %} - StockCraft</title>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm sticky-top"
    >
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="{{ url_for('home') }}"
          >StockCraft</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('home') }}">Home</a>
            </li>

            {% if current_user.is_authenticated %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('wallet') }}">Wallet</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('orders') }}">Order</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('stocks') }}">Stocks</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('portfolio_index') }}"
                >Portfolio</a
              >
            </li>

            {% if current_user.is_admin %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('admin_dashboard') }}"
                >Admin</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('users') }}">Users</a>
            </li>
            {% endif %} {% endif %}
          </ul>

          <ul class="navbar-nav ms-auto">
            {% if current_user.is_authenticated %}
            <li class="nav-item me-4">
              <span class="navbar-text text-warning fw-semibold">
                Wallet: {% if wallet_balance is not none %} ${{
                '%.2f'|format(wallet_balance) }} {% else %} $0.00 {% endif %}
              </span>
            </li>

            <li class="nav-item">
              <span class="navbar-text me-3">
                Hi, {{ current_user.username }}{% if current_user.is_admin %}
                (Admin){% endif %}
              </span>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </li>
            {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('login') }}">Login</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('signup') }}">Sign Up</a>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">{% block content %}{% endblock %}</div>

    <footer class="bg-dark text-light mt-5">
      <div class="container py-3">
        <p class="text-center mb-0">Â© 2025 Wealth Fargo Group</p>
      </div>
    </footer>

    <div
      class="modal fade"
      id="tradeConfirmModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="tradeModalTitle">Confirm Trade</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-between">
              <div>Action</div>
              <div id="mcAction" class="fw-semibold"></div>
            </div>
            <div class="d-flex justify-content-between">
              <div>Ticker</div>
              <div id="mcTicker" class="fw-semibold"></div>
            </div>
            <div class="d-flex justify-content-between">
              <div>Quantity</div>
              <div id="mcQty" class="fw-semibold"></div>
            </div>
            <div class="d-flex justify-content-between">
              <div>Price</div>
              <div id="mcPrice" class="fw-semibold"></div>
            </div>
            <hr class="opacity-25" />
            <div class="d-flex justify-content-between fs-5">
              <div>Total</div>
              <div id="mcTotal" class="fw-bold"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" id="mcConfirmBtn" class="btn btn-primary">
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function () {
        const REFRESH_MS = 15000;

        let pnlChart = null;
        const pnlCanvas = document.getElementById("pnlChart");
        if (pnlCanvas && window.Chart) {
          pnlChart = new Chart(pnlCanvas.getContext("2d"), {
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: "Unrealized P/L",
                  data: [],
                  tension: 0.25,
                  fill: false,
                  borderWidth: 2,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
                y: { ticks: { callback: (v) => "$" + Number(v).toFixed(2) } },
              },
            },
          });
        }

        function updatePortfolioTotalsAndChart() {
          const rows = document.querySelectorAll("[data-role='position-row']");
          let totalMV = 0,
            totalCost = 0;

          rows.forEach((row) => {
            const qty = Number(row.getAttribute("data-qty") || 0);
            const avg = Number(row.getAttribute("data-avg") || 0);
            const lastPriceEl = row.querySelector("[data-field='price']");
            let price = 0;
            if (lastPriceEl) {
              price = Number(
                String(lastPriceEl.textContent || "0").replace(/[^0-9.\-]/g, "")
              );
            }
            totalMV += qty * price;
            totalCost += qty * avg;
          });

          const pnl = totalMV - totalCost;

          const mvEl = document.getElementById("mvTotal");
          const costEl = document.getElementById("costTotal");
          const headEl = document.getElementById("pnlHeadline");

          if (mvEl) mvEl.textContent = `$${totalMV.toFixed(2)}`;
          if (costEl) costEl.textContent = `$${totalCost.toFixed(2)}`;
          if (headEl) {
            headEl.textContent = `${pnl >= 0 ? "+" : ""}$${pnl.toFixed(2)}`;
            headEl.classList.toggle("text-success", pnl >= 0);
            headEl.classList.toggle("text-danger", pnl < 0);
          }

          if (pnlChart) {
            const now = new Date();
            const label = now.toLocaleTimeString([], {
              hour12: false,
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
            pnlChart.data.labels.push(label);
            pnlChart.data.datasets[0].data.push(pnl);
            if (pnlChart.data.labels.length > 100) {
              pnlChart.data.labels.shift();
              pnlChart.data.datasets[0].data.shift();
            }
            pnlChart.update();
          }
        }

        function updateRowProceeds(row) {
          const qtyInput = row.querySelector("input[name='quantity']");
          const priceEl = row.querySelector("[data-field='price']");
          const proceedsElA = row.querySelector("[data-field='proceeds']");
          const proceedsElB = row.querySelector(".total-profit");
          const hiddenPrice = row.querySelector("input[name='price']");

          const qty = Number(qtyInput?.value || 0);
          const price = Number(
            String(priceEl?.textContent || "0").replace(/[^0-9.\-]/g, "") || 0
          );
          const total = (qty * price).toFixed(2);

          if (proceedsElA) proceedsElA.textContent = `$${total}`;
          if (proceedsElB) proceedsElB.textContent = `$${total}`;
          if (hiddenPrice) hiddenPrice.value = price.toFixed(2);
        }

        async function fetchPrices() {
          try {
            const res = await fetch("/update_stock_prices", {
              cache: "no-store",
            });
            if (!res.ok) return;
            const data = await res.json();

            document
              .querySelectorAll("[data-ticker][data-field]")
              .forEach((el) => {
                const tkr = el.getAttribute("data-ticker");
                if (!(tkr in data)) return;
                const live = Number(data[tkr]);
                const field = el.getAttribute("data-field");

                if (field === "price") {
                  const formatted = live.toFixed(2);
                  if (el.tagName === "INPUT") {
                    el.value = formatted;
                  } else {
                    el.textContent = `$${formatted}`;
                  }
                  el.dispatchEvent(
                    new CustomEvent("liveprice:update", {
                      detail: { ticker: tkr, price: live },
                    })
                  );
                }
              });

            document
              .querySelectorAll("[data-role='position-row']")
              .forEach((row) => {
                const tkr = row.getAttribute("data-ticker");
                if (!(tkr in data)) return;

                const price = Number(data[tkr]);
                const qty = Number(row.getAttribute("data-qty") || 0);
                const avg = Number(row.getAttribute("data-avg") || 0);

                const mktVal = qty * price;
                const pnl = qty * (price - avg);

                const mktValEl = row.querySelector("[data-field='mktval']");
                const pnlEl = row.querySelector("[data-field='pnl']");
                const lastPriceEl = row.querySelector("[data-field='price']");

                if (lastPriceEl)
                  lastPriceEl.textContent = `$${price.toFixed(2)}`;
                if (mktValEl) mktValEl.textContent = `$${mktVal.toFixed(2)}`;
                if (pnlEl) {
                  pnlEl.textContent = `$${pnl.toFixed(2)}`;
                  pnlEl.classList.toggle("text-success", pnl >= 0);
                  pnlEl.classList.toggle("text-danger", pnl < 0);
                }

                updateRowProceeds(row);
              });

            updatePortfolioTotalsAndChart();
          } catch (e) {}
        }

        let pendingForm = null;
        const modalEl = document.getElementById("tradeConfirmModal");
        const modal = modalEl ? new bootstrap.Modal(modalEl) : null;
        const elAction = document.getElementById("mcAction");
        const elTicker = document.getElementById("mcTicker");
        const elQty = document.getElementById("mcQty");
        const elPrice = document.getElementById("mcPrice");
        const elTotal = document.getElementById("mcTotal");
        const btnConfirm = document.getElementById("mcConfirmBtn");
        const modalTitle = document.getElementById("tradeModalTitle");

        document.addEventListener("submit", function (e) {
          const form = e.target;
          const confirmType = form.getAttribute("data-confirm");
          if (!confirmType || !modal) return;

          e.preventDefault();

          const action = (
            form.getAttribute("data-action") || "trade"
          ).toUpperCase();

          let tkr = (form.getAttribute("data-ticker") || "").toUpperCase();
          if (!tkr) {
            const sel = form.querySelector("select[name='stock_id']");
            const opt = sel ? sel.options[sel.selectedIndex] : null;
            if (opt && opt.dataset.ticker)
              tkr = String(opt.dataset.ticker).toUpperCase();
          }
          if (!tkr) {
            const row = form.closest("[data-role='position-row']");
            if (row)
              tkr = String(row.getAttribute("data-ticker") || "").toUpperCase();
          }

          const qty = Number(
            form.querySelector("input[name='quantity']")?.value || 0
          );

          let price = 0;
          const priceInput = form.querySelector("input[name='price']");
          if (priceInput && priceInput.value) {
            price = Number(priceInput.value);
          }
          if (!price) {
            const formPriceEl = form.querySelector(
              "[data-field='price'], [data-field='last-price']"
            );
            if (formPriceEl) {
              price = Number(
                String(formPriceEl.textContent || "0").replace(/[^0-9.\-]/g, "")
              );
            }
          }
          if (!price) {
            const row = form.closest("[data-role='position-row']");
            const rowPriceEl = row?.querySelector("[data-field='price']");
            if (rowPriceEl) {
              price = Number(
                String(rowPriceEl.textContent || "0").replace(/[^0-9.\-]/g, "")
              );
            }
          }
          if (!isFinite(price)) price = 0;

          const total = qty * price;

          if (modalTitle) modalTitle.textContent = `Confirm ${action}`;
          if (elAction) elAction.textContent = action;
          if (elTicker) elTicker.textContent = tkr || "-";
          if (elQty) elQty.textContent = qty.toString();
          if (elPrice) elPrice.textContent = `$${price.toFixed(2)}`;
          if (elTotal) elTotal.textContent = `$${total.toFixed(2)}`;

          if (priceInput) priceInput.value = price.toFixed(2);

          pendingForm = form;
          modal.show();
        });

        if (btnConfirm) {
          btnConfirm.addEventListener("click", function () {
            if (pendingForm) {
              modal.hide();
              const f = pendingForm;
              pendingForm = null;
              f.submit();
            }
          });
        }

        document
          .querySelectorAll("[data-role='position-row']")
          .forEach((row) => {
            const qtyInput = row.querySelector("input[name='quantity']");
            if (qtyInput) {
              qtyInput.addEventListener("input", () => updateRowProceeds(row));
              updateRowProceeds(row);
            }
          });

        fetchPrices();
        setInterval(fetchPrices, REFRESH_MS);
      })();
    </script>
  </body>
</html>
